name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for changelog

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build source distribution
      run: |
        python -m build --sdist

    - name: Build wheel
      run: |
        python -m build --wheel

    - name: Check distribution
      run: |
        twine check dist/*

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  extract-changelog:
    name: Extract Changelog
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      changelog: ${{ steps.extract.outputs.changelog }}
      version: ${{ steps.version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Extract changelog for version
      id: extract
      run: |
        VERSION=${{ steps.version.outputs.version }}

        # Check if CHANGELOG.md exists
        if [ ! -f CHANGELOG.md ]; then
          echo "changelog=No changelog available" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Extract section for this version using a robust pattern
        # Handles ## [X.Y.Z] and ## X.Y.Z formats, stops at next version header
        CHANGELOG=$(awk -v ver="$VERSION" '
          BEGIN { found=0; content="" }
          /^## \[?[0-9]+\.[0-9]+\.[0-9]+/ {
            if (found) exit
            if (index($0, ver) > 0) { found=1; next }
          }
          found { content = content $0 "\n" }
          END { print content }
        ' CHANGELOG.md | sed '/^$/d')

        if [ -z "$CHANGELOG" ]; then
          # Fallback: try simpler extraction
          CHANGELOG=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '1d;$d' | head -30)
        fi

        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="Release version ${VERSION}"
        fi

        # Use EOF delimiter for multiline output (GitHub Actions recommended approach)
        {
          echo "changelog<<EOF"
          echo "$CHANGELOG"
          echo "EOF"
        } >> $GITHUB_OUTPUT

  create-release:
    name: Create GitHub Release
    needs: [build, extract-changelog]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release v${{ needs.extract-changelog.outputs.version }}
        body: |
          ## What's Changed

          ${{ needs.extract-changelog.outputs.changelog }}

          ## Installation

          ```bash
          # Install from source
          pip install doc-guardian-${{ needs.extract-changelog.outputs.version }}.tar.gz

          # Or from wheel
          pip install doc_guardian-${{ needs.extract-changelog.outputs.version }}-py3-none-any.whl
          ```

          ## Verification

          ```bash
          python -c "import guardian; print(guardian.__version__)"
          ```

          Full Changelog: https://github.com/anthropics/doc-guardian/blob/main/CHANGELOG.md
        files: |
          dist/*.tar.gz
          dist/*.whl
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        token: ${{ secrets.GITHUB_TOKEN }}

  publish-pypi:
    name: Publish to PyPI
    needs: [build, create-release]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.repository == 'anthropics/doc-guardian'  # Only publish from official repo
    environment:
      name: pypi
      url: https://pypi.org/p/doc-guardian

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
        skip-existing: true
        verbose: true

  publish-test-pypi:
    name: Publish to Test PyPI
    needs: [build, create-release]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc')
    environment:
      name: test-pypi
      url: https://test.pypi.org/p/doc-guardian

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: Publish to Test PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        user: __token__
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        skip-existing: true
        verbose: true

  verify-release:
    name: Verify Release
    needs: [create-release]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: Install from wheel
      run: |
        pip install dist/*.whl

    - name: Verify installation
      run: |
        python -c "import guardian; print(f'Installed version: {guardian.__version__}')"
        guardian-heal --help
        guardian-install --help
        guardian-rollback --help

    - name: Run quick smoke test
      run: |
        python -c "
        from guardian.core.base import HealingSystem, HealingReport
        from guardian.healers.fix_broken_links import FixBrokenLinksHealer
        print('Core modules import successfully')
        print('Smoke test passed!')
        "

  release-summary:
    name: Release Summary
    needs: [build, extract-changelog, create-release, verify-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Check release status
      run: |
        echo "Release Status:"
        echo "  Build: ${{ needs.build.result }}"
        echo "  Extract Changelog: ${{ needs.extract-changelog.result }}"
        echo "  Create Release: ${{ needs.create-release.result }}"
        echo "  Verify Release: ${{ needs.verify-release.result }}"

        if [ "${{ needs.create-release.result }}" == "failure" ]; then
          echo "Release creation failed"
          exit 1
        fi

        echo "Release completed successfully!"
        echo "Version: v${{ needs.extract-changelog.outputs.version }}"
